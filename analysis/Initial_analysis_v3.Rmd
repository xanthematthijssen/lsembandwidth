---
title: "Initial analysis"
author: "X Matthijssen"
output: 
  html_document:
    toc: true
    theme: united
    toc_depth: 4
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = paste0(substr(inputFile,1,nchar(inputFile)-4),Sys.Date(),'.html')) })
---

```{r setup, echo = F, message = F, results = 'hide'}
# required packages 
if(!require(sirt)){install.packages("sirt"); library(sirt)}
if(!require(tidyverse)){install.packages("tidyverse"); library(tidyverse)}
if(!require(tidylog)){install.packages("tidylog"); library(tidylog)}
if(!require(devtools)){install.packages("devtools"); library(devtools)}
if(!require(mice)){install.packages("mice"); library(mice)}
if(!require(knitr)){install.packages("knitr"); library(knitr)}
if(!require(tableone)){install.packages("tableone"); library(tableone)}

load_all()

setwd("H:/lsembandwidth/analysis")

# General setup 
rm(list=ls())
set.seed(121212)

# start timer 
starting_time <- proc.time()


```


# Data preperation 

## Read  data 

```{r}
load("I:/Pi helm/Promovendi/Xanthe/4. Analyse hele EAC/EAC-nieuwe-start/0. Data/Produced/Beforeimp 2019-01-16.RData")

load("I:/Pi helm/Promovendi/Xanthe/4. Analyse hele EAC/EAC-nieuwe-start/0. Data/Produced/Naimp 2019-01-16.RData")

fulldata <- mice::complete(data_imp, include = T, action = 'long')
```
### ab_count
```{r}
load("I:/Pi helm/Promovendi/Xanthe/4. Analyse hele EAC/EAC-nieuwe-start/0. Data/Produced/ 2019-11-01 AB_info.RData")

```

## clean data 
```{r}

```


## Merge data 
```{r}

```

## Make variables 

### data 
```{r}
data <- data %>% mutate(inclusiejaar = format.Date(DAT1EBEZ,"%Y") %>% as.numeric) 


data <- data %>% mutate(
  TJC_conv = 0.56*sqrt(TJC28),
  SJC_conv = 0.28*sqrt(SJC28),
  ESR_conv = 0.70*logbse,
  GH_conv = 0.014*VASZACT
)


data <- data %>% select(EACNUMM, BEZNR, TJC28, SJC28, BSE, VASZACT,TJC_conv:GH_conv, inclusiejaar,
                        Age_incl,geslacht, sympt_dur_dgn, CCP2np, rf_neg_pos, das28, HAQ)

summary(data)
```

### fulldata 
```{r}


fulldata <- fulldata %>% mutate(
  TJC_conv = 0.56*sqrt(TJC28),
  SJC_conv = 0.28*sqrt(SJC28),
  logbse = if_else(BSE > 0, log(BSE), 0),
  ESR_conv = 0.70*logbse,
  GH_conv = 0.014*VASZACT
)


fulldata <- fulldata %>% select(EACNUMM, BEZNR, TJC28, SJC28, BSE, VASZACT, TJC_conv:GH_conv, .imp,
                        Age_incl,geslacht, sympt_dur_dgn, CCP2np, rf_neg_pos, das28, HAQ)
summary(fulldata)
```

### EACNUMMS
```{r}

```

## Subset data 
```{r}

data <- data %>% filter(!(is.na(TJC_conv) & is.na(SJC_conv) & is.na(ESR_conv) & !is.na(GH_conv)))


data_base <- data %>% filter(BEZNR ==1)

fulldata <- full_join(fulldata, select(data_base, EACNUMM, inclusiejaar))


fulldata <- filter(fulldata, !is.na(inclusiejaar) & .imp != 0)

# baseline

fulldata_base <- fulldata %>% filter(BEZNR ==1)

# antibodies 

fulldata_pos <- fulldata %>% subset(EACNUMM %in% EACNUMMs_ab_pos)

fulldata_neg <- fulldata %>% subset(EACNUMM %in% EACNUMMs_ab_neg)

# first set 
fulldata1 <- fulldata %>% filter(BEZNR ==1 & .imp == 1)

fulldata_pos1 <- fulldata1 %>% subset(EACNUMM %in% EACNUMMs_ab_pos)

fulldata_neg1 <- fulldata1 %>% subset(EACNUMM %in% EACNUMMs_ab_neg)



```

# Functions

```{r}
# function to make a nice table 1

write_table1 <- function(data, myVars = myVars, catVars = catVars,
                         stratum, name, write = FALSE, return = FALSE,
                         nonnormalVars = "") {
  CreateTableOne(
    data = data,
    factorVars = catVars,
    vars = myVars,
    strata = stratum
  ) %>%
    print(exact = catVars, nonnormal = nonnormalVars) -> table1
  
  if (write == T) {
    write.csv2(table1, paste("Tables/", Sys.Date(), name, ".csv", sep = ""))
  }
  if (return == T) {
    return(table1)
  }
}
```

# Constants
```{r}

lavmodel_int <- "
        F=~ 1*ESR_conv+SJC_conv+TJC_conv+GH_conv
        ESR_conv ~ 0
        SJC_conv ~ 1
        TJC_conv ~ 1
        GH_conv  ~ 1
        F ~ 1"

lavmodel_int2 <- "
        F=~ 1*GH_conv + ESR_conv+SJC_conv+TJC_conv
        GH_conv ~ 0
        SJC_conv ~ 1
        TJC_conv ~ 1
        ESR_conv ~ 1
        F ~ 1"

lavmodel_int3 <- "
        F=~ 1*SJC_conv+TJC_conv + GH_conv + ESR_conv
        SJC_conv ~ 0
        TJC_conv ~ 1
        GH_conv  ~ 1
        ESR_conv ~ 1
        F ~ 1"

lavmodel_int4 <- "
        F=~ 1*TJC_conv +SJC_conv+ GH_conv + ESR_conv
        TJC_conv ~ 0 
        SJC_conv ~ 1
        GH_conv  ~ 1
        ESR_conv ~ 1
        F ~ 1"

moderator_grid <- 1994:2016

bandwidths <- c(1,2,3,4,5,6,7)

# complete patienten op baseline
EACNUMMs_comp_base <- data_base  %>%
  select(EACNUMM, inclusiejaar, 
         GH_conv, TJC_conv, SJC_conv, ESR_conv) %>%
  na.omit() %>% pull(EACNUMM)


```

# Analyses 

## baseline


### constants 
```{r}
myVars <-
  c(
    "Age_incl",
    "geslacht",
    "sympt_dur_dgn",
    "CCP2np",
    "rf_neg_pos",
    "das28",
    "HAQ",
    "SJC28",
    "TJC28",
    "VASZACT",
    "BSE"
  )

catVars <-
  c(
    "geslacht",
    "CCP2np",
    "rf_neg_pos"
  )

nonnormalVars <-
  c(
    "Age_incl",
    "sympt_dur_dgn",
    "das28",
    "HAQ",
    "SJC28",
    "TJC28",
    "VASZACT",
    "BSE"
  )
```

### table 1 

```{r}

write_table1(
  data = data_base, myVars = myVars, catVars = catVars,
  nonnormalVars = nonnormalVars, name = "All"
)

write_table1(
  data = fulldata1, myVars = myVars, catVars = catVars,
  nonnormalVars = nonnormalVars, name = "All"
)


write_table1(
  data =mutate(data_base, inclusiejaar = cut(inclusiejaar,5)) , 
  myVars = myVars, catVars = catVars,
  nonnormalVars = nonnormalVars,
  stratum = "inclusiejaar", name = "inclusiejaar"
)

write_table1(
  data = mutate(fulldata1, inclusiejaar = cut(inclusiejaar,5)),
  myVars = myVars, catVars = catVars,
  nonnormalVars = nonnormalVars,
  stratum = "inclusiejaar", name = "inclusiejaar"
)

write_table1(
  data = mutate(data_base,ab_pos = EACNUMM %in% EACNUMMs_ab_pos) , 
  myVars = myVars, catVars = catVars,
  nonnormalVars = nonnormalVars,
  stratum = "ab_pos", name = "ab_pos"
)

write_table1(
  data = mutate(fulldata1,ab_pos = EACNUMM %in% EACNUMMs_ab_pos) , 
  myVars = myVars, catVars = catVars,
  nonnormalVars = nonnormalVars,
  stratum = "ab_pos", name = "ab_pos"
)
```

### other baseline
```{r}
data_base %>% group_by(inclusiejaar) %>%
  summarise(mean_na_sjc = mean(is.na(SJC_conv)),
            mean_na_tjc = mean(is.na(TJC_conv)),
            mean_na_esr = mean(is.na(ESR_conv)),
            mean_na_GH = mean(is.na(GH_conv))) %>%
  round(digits =2 ) %>% 
  as.data.frame() %>% kable()

apply(fulldata1 ,2 , sd)

```

## save image
```{r}
#save.image("../output/workspace/29-04-2020general.RData")
```

## factor model
```{r}
data_base %>%
  mutate( inclusiejaar5 = cut(inclusiejaar,5)) %>%
  select(inclusiejaar5, TJC_conv, SJC_conv, ESR_conv, GH_conv) %>% 
  group_split(inclusiejaar5)%>%
  lapply( function(x) round(cor(x[,2:5], use = "pairwise.complete.obs"), digits = 2))
  
  
```

## bandwidths 

### Hildebrandt bandwidhts

```{r}
calculate_bandwidth <- function(n, sd, h){
  bw <- (h* sd )/ n^0.2
  return(bw)
}

# these would be the bandwidths based on the bandwidht factors in hilderbrandt et al
hildebrandt_bw <- calculate_bandwidth(n = nrow(data_base), 
                    sd = sd(data_base$inclusiejaar), 
                    h = c(1.1,2,3))

hildebrandt_bw

bandwidths_base <- c(bandwidths, hildebrandt_bw)


# die van fulldata zijn hetzelfde 

calculate_bandwidth(n = nrow(fulldata %>% subset(BEZNR == 4 & .imp == 1)),
                    sd = sd(data_base$inclusiejaar), 
                    h = c(1.1,2,3))



calculate_bandwidth(n = nrow(fulldata %>% subset(BEZNR == 9 & .imp == 1)),
                    sd = sd(data_base$inclusiejaar), 
                    h = c(1.1,2,3))



```

### load bandwidths
```{r}

```



## Lsem.estimate 

### intercept model 

#### raw data 

```{r}
model_hild_int <- lsem.estimate(
    data_base,
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid,
    lavmodel = lavmodel_int,
    h = 2,
    est_joint = TRUE
)

summary(model_hild_int)

model_cv_int <- lsem.estimate(
    data_base ,
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid,
    lavmodel = lavmodel_int,
    bw = 9,
    est_joint = TRUE
)
summary(model_cv_int)


model_cv_int_pmod <- lsem.estimate(
    data_base ,
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid,
    lavmodel = lavmodel_int,
    bw = 9
)
summary(model_cv_int_pmod )

model_cv_int_pmod_pos <- lsem.estimate(
    data_base %>% subset(EACNUMM %in% EACNUMMs_ab_pos),
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid,
    lavmodel = lavmodel_int,
    bw = 12
)
summary(model_cv_int_pmod_pos  )

model_cv_int_pmod_neg <- lsem.estimate(
    data_base %>% subset(EACNUMM %in% EACNUMMs_ab_pos),
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid,
    lavmodel = lavmodel_int,
    bw = 9
)
summary(model_cv_int_pmod_neg  )






```

#### fulldata1
Geen est_joint want dat kan niet ptest

```{r}

model_cv_imp <- lsem.estimate(
    fulldata1 ,
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid,
    lavmodel = lavmodel_int,
    bw = 7
)
summary(model_cv_imp)
plot(model_cv_imp , parindex=1:9, ask = F)


model_cv_imp_bw2 <- lsem.estimate(
    fulldata1 ,
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid,
    lavmodel = lavmodel_int,
    bw = 4
)
summary(model_cv_imp_bw2)
plot(model_cv_imp_bw2 , parindex=1:9, ask = F)



```




####  AB strat 

```{r}


model_cv_imp_pos <- lsem.estimate(
    fulldata_pos1,
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid,
    lavmodel = lavmodel_int,
    bw = 12
)

summary(model_cv_imp_pos)

plot(model_cv_imp_pos , parindex=1:9, ask = F)

model_cv_imp_neg <- lsem.estimate(
    fulldata_neg1,
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid,
    lavmodel = lavmodel_int,
    bw = 9
)

summary(model_cv_imp_neg)
plot(model_cv_imp_neg , parindex=1:9, ask = F)

```


#### 1 en 5 j
```{r}
model_cv_imp_1j <- lsem.estimate(
    fulldata %>% subset(BEZNR == 4 & .imp == 1),
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid[moderator_grid < 2015],
    lavmodel = lavmodel_int,
    bw = 2
)
summary(model_cv_imp_1j)
plot(model_cv_imp_1j , parindex=1:9, ask = F)

model_cv_imp_3j <- lsem.estimate(
    fulldata %>% subset(BEZNR == 8 & .imp == 1),
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid[moderator_grid < 2015],
    lavmodel = lavmodel_int,
    bw = 2
)
summary(model_cv_imp_3j)
plot(model_cv_imp_3j , parindex=1:9, ask = F)

model_cv_imp_5j <- lsem.estimate(
    fulldata %>% subset(BEZNR == 9 & .imp == 1),
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid[moderator_grid < 2011],
    lavmodel = lavmodel_int,
    bw = 2
)
summary(model_cv_imp_5j)
plot(model_cv_imp_5j , parindex=1:9, ask = F)
```


### pmods
Dit zijn degene waarvoor ik geen perimp heb 


```{r}
load("../output/pmods/2020-04-25B1000pmod_cv_int2.RData")
load("../output/pmods/2020-04-29B1000pmod_cv_imp_set1_5j.RData")
load("../output/pmods/2020-04-29B1000pmod_cv_imp_set1_3j.RData")
load("../output/pmods/2020-04-29B1000pmod_cv_imp_set1_1j.RData")
load("../output/pmods/2020-04-29B1000pmod_cv_imp_set1_bw2.RData")
load("../output/pmods/2020-04-24B1000pmod_cv_imp_set1.RData")

# bandwidth maakt niet uit voor p
pmod_cv_imp$teststat
pmod_cv_imp_bw2$teststat

# raw similar maar geen p 
pmod_cv_int2$teststat

# op 1 jaar vooor GH meer belangrijk 
pmod_cv_imp_1j$teststat
pmod_cv_imp_3j$teststat
pmod_cv_imp_5j$teststat

```



### summarise permuatiion Imp 

```{r, eval = T}


extract_pars <- function(location){
  assign('pmod', get(load(paste("H:/lsembandwidth/output/perimp/",
                                location,
                                sep = "")))) 
  pars <- pmod$teststat
  pars$name <- location
  return(pars)  
}

summarise_p <- function(par_dfs){
  par_dfs %>% select(-name) %>% group_by(par) %>%
    summarise_all(list(
      min = min,
      max = max,
      mean = mean, 
      median = median,
      length = length
    ))
}

summarise_models <- function(summ) {
  summ %>% 
    select(par, lin_slo_mean, lin_slo_p_mean,lin_slo_p_median,
           SD_p_mean, SD_p_median, SD_p_length) %>%
    mutate(lin_slo_mean = round(lin_slo_mean , digits = 2)) %>% 
    as.data.frame %>% 
    print()
}

list.files("../output/perimp/") %>% subset(str_detect(., "pos")) %>%
  map_dfr(extract_pars) %>% summarise_p -> p_df_pos


p_df_pos %>% summarise_models()


list.files("../output/perimp/") %>% subset(str_detect(., "neg")) %>%
  map_dfr(extract_pars) %>% summarise_p -> p_df_neg


p_df_neg %>% summarise_models()


list.files("../output/perimp/") %>% 
  subset(!str_detect(., "neg") & !str_detect(.,"pos")) %>%
  map_dfr(extract_pars) %>% summarise_p -> p_df


p_df %>% summarise_models()
```








# Summary 

# Session info

```{r}
sessionInfo() 

proc.time() - starting_time
```

