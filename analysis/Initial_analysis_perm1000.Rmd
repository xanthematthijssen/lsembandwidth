---
title: "Initial analysis"
author: "X Matthijssen"
output: 
  html_document:
    toc: true
    theme: united
    toc_depth: 2
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = paste0(substr(inputFile,1,nchar(inputFile)-4),Sys.Date(),'.html')) })
---

```{r setup, echo = F, message = F, results = 'hide'}
# required packages 
if(!require(sirt)){install.packages("sirt"); library(sirt)}
if(!require(tidyverse)){install.packages("tidyverse"); library(tidyverse)}
if(!require(tidylog)){install.packages("tidylog"); library(tidylog)}
if(!require(devtools)){install.packages("devtools"); library(devtools)}
if(!require(mice)){install.packages("mice"); library(mice)}
load_all()

setwd("H:/lsembandwidth/analysis")

# General setup 
rm(list=ls())
set.seed(121212)

# start timer 
starting_time <- proc.time()

# bepaling hoeveel er opnieuw wordt gerund 
bandwidthrun <- FALSE
permuatationrun <- TRUE 
```


# Data preperation 

## Read  data 

```{r}
load("I:/Promovendi_Annette/Xanthe/4. Analyse hele EAC/EAC-nieuwe-start/0. Data/Produced/Beforeimp 2019-01-16.RData")

load("I:/Promovendi_Annette/Xanthe/4. Analyse hele EAC/EAC-nieuwe-start/0. Data/Produced/Naimp 2019-01-16.RData")

fulldata <- mice::complete(data_imp, include = T, action = 'long')
```
### ab_count
```{r}
load("I:/Promovendi_Annette/Xanthe/4. Analyse hele EAC/EAC-nieuwe-start/0. Data/Produced/ 2019-11-01 AB_info.RData")

```

## clean data 
```{r}

```


## Merge data 
```{r}

```

## Make variables 

### data 
```{r}
data <- data %>% mutate(inclusiejaar = format.Date(DAT1EBEZ,"%Y") %>% as.numeric) 


data <- data %>% mutate(
  TJC_conv = 0.56*sqrt(TJC28),
  SJC_conv = 0.28*sqrt(SJC28),
  ESR_conv = 0.70*logbse,
  GH_conv = 0.014*VASZACT
)


data <- data %>% select(EACNUMM, BEZNR, TJC_conv:GH_conv, inclusiejaar)

summary(data)
```

### fulldata 
```{r}


fulldata <- fulldata %>% mutate(
  TJC_conv = 0.56*sqrt(TJC28),
  SJC_conv = 0.28*sqrt(SJC28),
  ESR_conv = 0.70*log(BSE +1),
  GH_conv = 0.014*VASZACT
)




fulldata <- fulldata %>% select(EACNUMM, BEZNR, TJC_conv:GH_conv, .imp)
summary(fulldata)
```


## Subset data 
```{r}

data<- data %>% filter(!(is.na(TJC_conv) & is.na(SJC_conv) & is.na(ESR_conv) & !is.na(GH_conv)))


data_base <- data %>% filter(BEZNR ==1)

fulldata <- full_join(fulldata, select(data_base, EACNUMM, inclusiejaar))

fulldata <- filter(fulldata, !is.na(inclusiejaar))

fulldata_base <- fulldata %>% filter(BEZNR ==1 & .imp != 0)
fulldata1 <- fulldata %>% filter(BEZNR ==1 & .imp == 1)


fulldata_pos <- fulldata_base %>% subset(EACNUMM %in% EACNUMMs_ab_pos)
fulldata_neg <- fulldata_base %>% subset(EACNUMM %in% EACNUMMs_ab_neg)
```

# Functions

# Constants
```{r}
# intercepts will follow automaticly
lavmodel <- "
        F=~ ESR_conv+SJC_conv+TJC_conv+GH_conv
"
lavmodel_int <- "
        F=~ 1*ESR_conv+SJC_conv+TJC_conv+GH_conv
        ESR_conv ~ 1
        SJC_conv ~ 1
        TJC_conv ~ 1
        GH_conv  ~ 1"

lavmodel_int2 <- "
        F=~ 1*ESR_conv+SJC_conv+TJC_conv+GH_conv
        ESR_conv ~ 1
        SJC_conv ~ 1
        TJC_conv ~ 1
        GH_conv  ~ 1
        F ~ 1"



moderator_grid <- unique(data$inclusiejaar) %>% as.numeric()

bandwidths <- c(2,5,10,15)


```

# Analyses 

## bandwidths 

### Hildebrandt

```{r}
calculate_bandwidth <- function(n, sd, h){
  bw <- (h* sd )/ n^0.2
  return(bw)
}

# these would be the bandwidths based on the bandwidht factors in hilderbrandt et al
hildebrandt_bw <- calculate_bandwidth(n = nrow(data_base), 
                    sd = sd(data_base$inclusiejaar), 
                    h = c(1.1,2,3))

hildebrandt_bw

bandwidths <- c(bandwidths, hildebrandt_bw)

```


### AIC 
Lower AIC is better 
Since the bandwidht is not included in the AIC, smaller bandwidht is better 

```{r}
if(bandwidthrun) {
  bw_aic <- test_bandwidths(
    data = data_base,
    lavmodel = lavmodel_int,
    bandwidthvector = bandwidths,
    moderator_name = "inclusiejaar",
    moderator_grid = moderator_grid,
    statistic = "AIC"
  )
  
  print(as.data.frame(bw_aic))
  
  save(bw_aic,
       file = paste("../output/", Sys.Date(), "bw_aic.RData", sep = ""))
}


```

TODO load en print hier voor later 

```{r}

```

### CV
Lower deviance is better 

#### intercept model 

bandwidht 9 is best with mean 
```{r}

if(bandwidthrun) {
  bw_int <- test_bandwidths(
    data = data_base,
    lavmodel = lavmodel_int,
    bandwidthvector = c(bandwidths, 5:15),
    moderator_name = "inclusiejaar",
    moderator_grid = moderator_grid,
    statistic = "CV",
    silent = TRUE
  )
  
  print(as.data.frame(bw_int))
  
  save(bw_int,
       file = paste("../output/", Sys.Date(), "bw_int.RData", sep = ""))
  
}


```


```{r, eval = !bandwidthrun}
load("../output/2020-04-22bw_int.RData")

print(as.data.frame(bw_int))
```

### imputation 
Op een dataset want meerdere dataset is nog niet implemented 
6 lijkte de beste 

```{r}
if(bandwidthrun) {

  bw_int_imp1 <- test_bandwidths(
    data = fulldata1,
    lavmodel = lavmodel_int,
    bandwidthvector = c(bandwidths,6),
    moderator_name = "inclusiejaar",
    moderator_grid = moderator_grid,
    statistic = "CV",
    silent = TRUE,
  )
  
  print(as.data.frame(bw_int_imp1))
  
  save( bw_int_imp1,
       file = paste("../output/", Sys.Date(), "bw_int_imp1.RData", sep = ""))
  
}
```


```{r, eval = !bandwidthrun}

load("../output/2020-04-22bw_int_imp1.RData")

print(as.data.frame(bw_int_imp1))
```

### imputation pos 

10 is het beste 
```{r}
if(bandwidthrun) {

  bw_int_imp1_pos <- 
  test_bandwidths(
    data = fulldata1 %>% subset(EACNUMM %in% EACNUMMs_ab_pos),
    lavmodel = lavmodel_int,
    bandwidthvector = c(bandwidths,6,7,8,9,11,12,13,14),
    moderator_name = "inclusiejaar",
    moderator_grid = moderator_grid,
    statistic = "CV",
    silent = TRUE,
  )
  print(as.data.frame(bw_int_imp1_pos))
  
  save( bw_int_imp1_pos,
       file = paste("../output/", Sys.Date(), "bw_int_imp1_pos.RData", sep = ""))
  
}
```


```{r, eval = !bandwidthrun}

#load("../output/2020-04-22bw_int_imp1_pos.RData")

#print(as.data.frame(bw_int_imp1_pos))
```

### imputation neg 
8 is iets beter maar 9 convergeert 
```{r}
if(bandwidthrun) {

  bw_int_imp1_neg <- test_bandwidths(
    data = fulldata1 %>% subset(EACNUMM %in% EACNUMMs_ab_neg),
    lavmodel = lavmodel_int,
    bandwidthvector = c(bandwidths,6,7,8,9,11,12,13,14), 
    moderator_name = "inclusiejaar",
    moderator_grid = moderator_grid,
    statistic = "CV",
    silent = TRUE,
  )
  
  print(as.data.frame(bw_int_imp1_neg))
  
  save( bw_int_imp1_neg,
       file = paste("../output/", Sys.Date(), "bw_int_imp1_neg.RData", sep = ""))
  
}
```


```{r, eval = !bandwidthrun}

#load("../output/2020-04-22bw_int_imp1_neg.RData")

#print(as.data.frame(bw_int_imp1_neg))
```

## Lsem.estimate 

### intercept model 

#### raw data 

```{r}
model_hild_int <- lsem.estimate(
    data_base,
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid,
    lavmodel = lavmodel_int,
    h = 2
)

summary(model_hild_int)
plot(model_hild_int, parindex=1:9, ask = F)

model_cv_int <- lsem.estimate(
    data_base ,
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid,
    lavmodel = lavmodel_int,
    bw = 9
)
summary(model_cv_int)
plot(model_hild_int, parindex=1:8, ask = F)


```


#### pseudoweights
```{r}
# does not converge 
# model_hild_int_imp_all <- lsem.estimate(
#     fulldata_base,
#     moderator = "inclusiejaar",
#     moderator.grid = moderator_grid,
#     lavmodel = lavmodel_int,
#     h = 2,
#     sampling_weights = rep(1/30, nrow(fulldata_base))
# )
# 
# summary(model_hild_int_imp_all)
# plot(model_hild_int_imp_all, parindex=1:8, ask = F)

model_cv_int_imp_all <- lsem.estimate(
    fulldata %>% subset( .imp != 0 & BEZNR ==1),
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid,
    lavmodel = lavmodel_int,
    bw = 6,
    sampling_weights = rep(1/30, nrow(fulldata_base))
)
summary(model_cv_int_imp_all)
plot(model_cv_int_imp_all, parindex=1:8, ask = F)
```

#### AB strat 

```{r}
model_hild_int_imp_all_pos <- lsem.estimate(
    fulldata_pos,
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid,
    lavmodel = lavmodel_int,
    h = 2,
    sampling_weights = rep(1/30, nrow(fulldata_pos))
)

summary(model_hild_int_imp_all_pos)
plot(model_hild_int_imp_all_pos , parindex=1:8, ask = F)

model_cv_int_imp_all_pos <- lsem.estimate(
    fulldata_pos,
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid,
    lavmodel = lavmodel_int,
    bw = 10,
    sampling_weights = rep(1/30, nrow(fulldata_pos))
)

summary(model_cv_int_imp_all_pos)
plot(model_cv_int_imp_all_pos , parindex=1:8, ask = F)

# Does not converge 
# model_hild_int_imp_all_neg <- lsem.estimate(
#     fulldata_neg,
#     moderator = "inclusiejaar",
#     moderator.grid = moderator_grid,
#     lavmodel = lavmodel_int,
#     h = 2,
#     sampling_weights = rep(1/30, nrow(fulldata_neg))
# )
# 
# summary(model_hild_int_imp_all_neg)
# plot(model_hild_int_imp_all_neg , parindex=1:8, ask = F)

model_cv_int_imp_all_neg <- lsem.estimate(
    fulldata_neg,
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid,
    lavmodel = lavmodel_int,
    bw = 9,
    sampling_weights = rep(1/30, nrow(fulldata_neg))
)

summary(model_cv_int_imp_all_neg)
plot(model_cv_int_imp_all_neg , parindex=1:8, ask = F)
```



## Permutation


```{r}
B <- 1000

  pmod_hild_int <-
    lsem.permutationTest(model_hild_int,
                         B = B)
  
  save(pmod_hild_int,
       file = paste("../output/",
                    Sys.Date(),
                    B,
                    "pmod_hild_int.RData", sep = ""))
  
  summary(pmod_hild_int)
  
  pmod_cv_int <- lsem.permutationTest(model_hild_int,
                                      B = B)
  
  save(pmod_cv_int,
       file = paste("../output/",
                    Sys.Date(), 
                    B,
                    "pmod_cv_int.RData", sep = ""))
  
  summary(pmod_cv_int)
  
  # performed seperately
  # pmod_cv_int_imp <- lsem.permutationTest(model_cv_int_imp_all,
  #                                         B = B)
  # 
  # save(
  #   pmod_cv_int_imp,
  #   file = paste("../output/",
  #                Sys.Date(),
  #                B,
  #                "pmod_cv_int_imp.RData", sep = "")
  # )
  # 
  # summary(pmod_cv_int_imp)
  
  pmod_cv_int_imp_pos <- lsem.permutationTest(model_cv_int_imp_all_pos,
                                          B =B)
  
  save(
    pmod_cv_int_imp_pos,
    file = paste("../output/",
                 Sys.Date(),
                 B,
                 "pmod_cv_int_imp_pos.RData", sep = "")
  )
  
  summary(pmod_cv_int_imp_pos)
  
  pmod_cv_int_imp_neg <- 
    lsem.permutationTest(model_cv_int_imp_all_neg,
                                          B = B)
  
  save(
    pmod_cv_int_imp_neg,
    file = paste("../output/",
                 Sys.Date(),
                 B,
                 "pmod_cv_int_imp_neg.RData", sep = "")
  )
  
  summary(pmod_cv_int_imp_neg)
  

```

TODO als permatuation run is geweest hier invullen
```{r}

```



# Oude resultaten, not run voor snelheid 

## 2020-4-21

### maakt aantal focal points uit  voor bandwidth? -> Nee

```{r, eval = F}

moderator_grid2 <- c(1995,2000,2005,2010,2015)
moderator_grid3 <- 1995:2015

lavmodel_int <- "
        F=~ ESR_conv+SJC_conv+TJC_conv+GH_conv
          ESR_conv ~ 1
  SJC_conv ~ 1
  TJC_conv~ 1
  GH_conv ~ 1
"

test_bandwidths(
  data = data_base,
  lavmodel = lavmodel_int,
  bandwidthvector = bandwidths,
  moderator_name = "inclusiejaar",
  moderator_grid = moderator_grid2,
  statistic = "CV",
  silent = TRUE
)

test_bandwidths(
  data = data_base,
  lavmodel = lavmodel_int,
  bandwidthvector = bandwidths,
  moderator_name = "inclusiejaar",
  moderator_grid = moderator_grid3,
  statistic = "CV",
  silent = TRUE
)


test_bandwidths(
  data = data_base,
  lavmodel = lavmodel_int,
  bandwidthvector = bandwidths,
  moderator_name = "inclusiejaar",
  moderator_grid = moderator_grid2,
  statistic = "AIC"
)

test_bandwidths(
  data = data_base,
  lavmodel = lavmodel_int,
  bandwidthvector = bandwidths,
  moderator_name = "inclusiejaar",
  moderator_grid = moderator_grid3,
  statistic = "AIC"
)



```

### model zonder intercept 
```{r, eval = F}
pmod1 <-lsem.permutationTest(
 lsem.estimate(
    data_base,
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid,
    lavmodel = lavmodel,
    h = 2,
    fit_measures = "aic"
  ),
  B = 1000
)

save(pmod1, file = paste("../output/", Sys.Date(), "pmod1.RData", sep = ""))

load("../output/2020-04-16pmod1.RData")

summary(pmod1)

```




# Summary 

# Session info

```{r}
sessionInfo() 

proc.time() - starting_time
```

