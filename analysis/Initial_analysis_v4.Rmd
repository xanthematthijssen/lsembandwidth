---
title: "Initial analysis"
author: "X Matthijssen"
output: 
  html_document:
    toc: true
    theme: united
    toc_depth: 4
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = paste0(substr(inputFile,1,nchar(inputFile)-4),Sys.Date(),'.html')) })
---

```{r setup, echo = F, message = F, results = 'hide'}
# required packages 
if(!require(sirt)){install.packages("sirt"); library(sirt)}
if(!require(tidyverse)){install.packages("tidyverse"); library(tidyverse)}
if(!require(tidylog)){install.packages("tidylog"); library(tidylog)}
if(!require(devtools)){install.packages("devtools"); library(devtools)}
if(!require(mice)){install.packages("mice"); library(mice)}
if(!require(knitr)){install.packages("knitr"); library(knitr)}
if(!require(tableone)){install.packages("tableone"); library(tableone)}

load_all()

setwd("H:/lsembandwidth/analysis")

# General setup 
rm(list=ls())
set.seed(121212)

# start timer 
starting_time <- proc.time()


```


# Data preperation 

## Read  data 

```{r}
load("I:/Pi helm/Promovendi/Xanthe/4. Analyse hele EAC/EAC-nieuwe-start/0. Data/Produced/Beforeimp 2019-01-16.RData")

```
### ab_count
```{r}
load("I:/Pi helm/Promovendi/Xanthe/4. Analyse hele EAC/EAC-nieuwe-start/0. Data/Produced/ 2019-11-01 AB_info.RData")

```

## clean data 
```{r}

```


## Merge data 
```{r}

```

## Make variables 

### data 
```{r}
data <- data %>% mutate(inclusiejaar = format.Date(DAT1EBEZ,"%Y") %>% as.numeric) 

data <- data %>% mutate(inclusietijd = as.numeric(DAT1EBEZ)/1000) 
data <- data %>% mutate(inclusietijd = inclusietijd - min(data$inclusietijd))

data <- data %>% mutate(
  TJC_conv = 0.56*sqrt(TJC28),
  SJC_conv = 0.28*sqrt(SJC28),
  ESR_conv = 0.70*logbse,
  GH_conv = 0.014*VASZACT
)


data <- data %>% select(EACNUMM, BEZNR, TJC28, SJC28, BSE, VASZACT,TJC_conv:GH_conv, inclusiejaar,
                        Age_incl,geslacht, sympt_dur_dgn, CCP2np, rf_neg_pos, das28, HAQ,inclusietijd)

summary(data)
```

### EACNUMMS
```{r}

```

## Subset data 
```{r}

data <- data %>% filter(!(is.na(TJC_conv) & is.na(SJC_conv) & is.na(ESR_conv) & !is.na(GH_conv)))


data_base <- data %>% filter(BEZNR ==1)



```

# Functions

```{r}
# function to make a nice table 1

write_table1 <- function(data, myVars = myVars, catVars = catVars,
                         stratum, name, write = FALSE, return = FALSE,
                         nonnormalVars = "") {
  CreateTableOne(
    data = data,
    factorVars = catVars,
    vars = myVars,
    strata = stratum
  ) %>%
    print(exact = catVars, nonnormal = nonnormalVars) -> table1
  
  if (write == T) {
    write.csv2(table1, paste("Tables/", Sys.Date(), name, ".csv", sep = ""))
  }
  if (return == T) {
    return(table1)
  }
}
```

# Constants
```{r}

lavmodel_int <- "
        F=~ 1*ESR_conv+SJC_conv+TJC_conv+GH_conv
        ESR_conv ~ 0
        SJC_conv ~ 1
        TJC_conv ~ 1
        GH_conv  ~ 1
        F ~ 1"

lavmodel_int2 <- "
        F=~ 1*GH_conv + ESR_conv+SJC_conv+TJC_conv
        GH_conv ~ 0
        SJC_conv ~ 1
        TJC_conv ~ 1
        ESR_conv ~ 1
        F ~ 1"

lavmodel_int3 <- "
        F=~ 1*SJC_conv+TJC_conv + GH_conv + ESR_conv
        SJC_conv ~ 0
        TJC_conv ~ 1
        GH_conv  ~ 1
        ESR_conv ~ 1
        F ~ 1"

lavmodel_int4 <- "
        F=~ 1*TJC_conv +SJC_conv+ GH_conv + ESR_conv
        TJC_conv ~ 0 
        SJC_conv ~ 1
        GH_conv  ~ 1
        ESR_conv ~ 1
        F ~ 1"

moderator_grid <- 1994:2016

bandwidths <- c(1,2,3,4,5,6,7)

# complete patienten op baseline
EACNUMMs_comp_base <- data_base  %>%
  select(EACNUMM, inclusiejaar, 
         GH_conv, TJC_conv, SJC_conv, ESR_conv) %>%
  na.omit() %>% pull(EACNUMM)


```

# Analyses 

## baseline


### constants 
```{r}
myVars <-
  c(
    "Age_incl",
    "geslacht",
    "sympt_dur_dgn",
    "CCP2np",
    "rf_neg_pos",
    "das28",
    "HAQ",
    "SJC28",
    "TJC28",
    "VASZACT",
    "BSE"
  )

catVars <-
  c(
    "geslacht",
    "CCP2np",
    "rf_neg_pos"
  )

nonnormalVars <-
  c(
    "Age_incl",
    "sympt_dur_dgn",
    "das28",
    "HAQ",
    "SJC28",
    "TJC28",
    "VASZACT",
    "BSE"
  )
```

### table 1 

```{r}

write_table1(
  data = data_base, myVars = myVars, catVars = catVars,
  nonnormalVars = nonnormalVars, name = "All"
)



write_table1(
  data =mutate(data_base, inclusiejaar = cut(inclusiejaar,5)) , 
  myVars = myVars, catVars = catVars,
  nonnormalVars = nonnormalVars,
  stratum = "inclusiejaar", name = "inclusiejaar"
)


```

## factor model
```{r}
data_base %>%
  mutate( inclusiejaar5 = cut(inclusiejaar,5)) %>%
  select(inclusiejaar5, TJC_conv, SJC_conv, ESR_conv, GH_conv) %>% 
  group_split(inclusiejaar5)%>%
  lapply( function(x) round(cor(x[,2:5], use = "pairwise.complete.obs"), digits = 2))
  
  
```

## bandwidths 

### Hildebrandt bandwidhts

```{r}
calculate_bandwidth <- function(n, sd, h){
  bw <- (h* sd )/ n^0.2
  return(bw)
}

# these would be the bandwidths based on the bandwidht factors in hilderbrandt et al
hildebrandt_bw <- calculate_bandwidth(n = nrow(data_base), 
                    sd = sd(data_base$inclusietijd), 
                    h = c(10:30)/10)

hildebrandt_bw

hildebrandt_bw2 <- calculate_bandwidth(n = nrow(data_base), 
                    sd = sd(data_base$inclusietijd), 
                    h = c(1:10))

hildebrandt_bw2

hildebrandt_bw3 <- calculate_bandwidth(n = nrow(data_base), 
                    sd = sd(data_base$inclusietijd), 
                    h = c(1:10))

hildebrandt_bw3


```

### load bandwidths
```{r, eval = F}
deviances_base <- test_bandwidths(
  data = data_base,
  lavmodel = lavmodel_int,
  bandwidthvector =   hildebrandt_bw2 ,
  moderator_name = "inclusietijd",
  moderator_grid = c(1:8)*1000,
  K = 5,
  statistic = "CV",
  silent = F
)


deviances_base3 <- test_bandwidths(
  data = data_base,
  lavmodel = lavmodel_int3,
  bandwidthvector =   hildebrandt_bw3,
  moderator_name = "inclusiejaar",
  moderator_grid = moderator_grid,
  K = 10,
  statistic = "CV",
  silent = F
)


write.csv2(deviances_base, file = paste(Sys.Date(), "deviances_base.csv"))

write.csv2(deviances_base2, file = paste(Sys.Date(), "deviances_base2.csv"))
write.csv2(deviances_base3, file = paste(Sys.Date(), "deviances_base3.csv"))
```

```{r} 
deviances_base <- read.csv2("2020-08-16 deviances_base.csv")

deviances_base <- deviances_base %>% group_by(bandwidth) %>% summarise(sum_dev = sum(deviance_test_data))


ggplot(deviances_base, aes(x= bandwidth/1000, y = sum_dev))+ 
  geom_point() + 
  geom_smooth() + 
  theme_minimal()+ 
  ylab("Deviance") + xlab("Bandwidth")


```

```{r}
deviances_base3 <- read.csv2("2020-08-14 deviances_base3.csv")
deviances_base3 <- deviances_base3 %>% group_by(bandwidth) %>% summarise(sum_dev = sum(deviance_test_data))


ggplot(deviances_base3, aes(x= bandwidth, y = sum_dev))+ 
  geom_point() + 
  geom_smooth() + 
  theme_minimal()

  
```


## Lsem.estimate 

### intercept model 

#### raw data 

```{r}
model_hild_int <- lsem.estimate(
    data_base,
    moderator = "inclusietijd",
    moderator.grid = 1:8*1000,
    lavmodel = lavmodel_int,
    h = 2
)

summary(model_hild_int)

model_cv_int <- lsem.estimate(
    data_base ,
    moderator = "inclusietijd",
    moderator.grid =  1:8,
    lavmodel = lavmodel_int,
    bw = 5
)
summary(model_cv_int)

plot(model_cv_int, ask = F)

model_hild_int3 <- lsem.estimate(
    data_base,
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid,
    lavmodel = lavmodel_int3,
    h = 2,
    est_joint = F, 
    sufficient_statistics = F
)

summary(model_hild_int3)

model_cv_int3 <- lsem.estimate(
    data_base ,
    moderator = "inclusiejaar",
    moderator.grid = moderator_grid,
    lavmodel = lavmodel_int3,
    bw = 12,
    est_joint = F, 
    sufficient_statistics = F
)
summary(model_cv_int3)
plot(model_cv_int3, ask = F)


```


### pmods
Dit zijn degene waarvoor ik geen perimp heb 


```{r, eval = F}
pmod_hild_int <-
    lsem.permutationTest(model_hild_int,
                         B = 1000)

pmod_cv_int <-
    lsem.permutationTest(model_cv_int,
                         B = 1000)

pmod_hild_int3 <-
    lsem.permutationTest(model_hild_int3,
                         B = 1000)

pmod_cv_int3 <-
    lsem.permutationTest(model_cv_int3,
                         B = 1000)

save(pmod_cv_int, pmod_cv_int3, pmod_hild_int, pmod_hild_int3, file = paste(Sys.Date(), "pmods.RData"))

save(pmod_cv_int, file = paste(Sys.Date(), "pmods.RData"))
```



### summarise permuatiion Imp 

```{r, eval = T}



load("2020-08-14 pmods.RData")
load("2020-08-16 pmods.RData")
pmod_cv_int$teststat %>% kable()
pmod_cv_int3$teststat%>% kable()
pmod_hild_int$teststat%>% kable()
pmod_hild_int3$teststat%>% kable()
```








# Summary 

# Session info

```{r}
sessionInfo() 

proc.time() - starting_time
```

